<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Character Dashboard - Malfian's Vault</title>
    <!-- Cache buster: 2025-01-08-v4 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <script>
        console.log('Dashboard loaded, cache version v4 - ' + new Date().toISOString());
        window.addEventListener('error', function(e) {
            console.error('JavaScript error:', e.error);
        });
    </script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Text:wght@400;600&display=swap');
        
        :root {
            --primary-bg: #0a0e1a;
            --secondary-bg: #141925;
            --accent-bg: #1e2436;
            --border-color: #2a3142;
            --text-primary: #e8eaf0;
            --text-secondary: #9ca3b8;
            --accent-color: #7c3aed;
            --accent-hover: #6d28d9;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --gold-color: #fbbf24;
            --magic-glow: #c084fc;
            --legendary-color: #f97316;
        }

        body {
            background: var(--primary-bg);
            background-image: 
                radial-gradient(ellipse at top left, rgba(124, 58, 237, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at bottom right, rgba(192, 132, 252, 0.05) 0%, transparent 50%);
            color: var(--text-primary);
            font-family: 'Crimson Text', serif;
            margin: 0;
            padding: 0;
        }

        .main-container {
            height: 100vh;
            display: flex;
        }

        /* Sidebar */
        .sidebar {
            width: 400px;
            background: var(--secondary-bg);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            background: var(--accent-bg);
        }

        .character-list {
            padding: 1rem;
        }

        .character-card {
            background: var(--accent-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 1rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .character-card:hover {
            border-color: var(--accent-color);
            background: var(--secondary-bg);
        }

        .character-card.active {
            border-color: var(--accent-color);
            background: var(--secondary-bg);
            box-shadow: 0 0 0 1px var(--accent-color);
        }

        .character-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .character-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .stat-item {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .stat-label {
            font-weight: 500;
            color: var(--text-primary);
        }

        .password-field {
            font-family: monospace;
            letter-spacing: 2px;
            color: var(--text-secondary);
        }

        .password-hidden {
            filter: blur(3px);
            transition: filter 0.2s ease;
        }

        .password-hidden:hover {
            filter: blur(0);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            background: var(--primary-bg);
            overflow-y: auto;
        }

        .content-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            background: var(--secondary-bg);
        }

        .content-body {
            padding: 1.5rem;
        }

        /* Character Details */
        .character-details {
            display: none;
        }

        .character-details.active {
            display: block;
        }

        .detail-card {
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        .detail-card-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            background: var(--accent-bg);
            border-radius: 8px 8px 0 0;
        }

        .detail-card-body {
            padding: 1.5rem;
        }

        /* MUD Terminal Styles */
        .mud-terminal {
            background-color: #000;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            padding: 1rem;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            max-height: 600px;
            overflow-y: auto;
            font-size: 0.875rem;
            line-height: 1.4;
        }

        .mud-header {
            color: #00ff00;
            font-weight: bold;
            margin-bottom: 0.5rem;
            border-bottom: 1px solid #333;
            padding-bottom: 0.25rem;
        }

        .mud-line {
            display: flex;
            margin-bottom: 0.1rem;
        }

        .equipment-slot-mud {
            color: #ffff00;
            min-width: 200px;
            display: inline-block;
        }

        .item-text {
            color: #00ff00;
            flex-grow: 1;
            padding-left: 0.5rem;
        }

        /* Container styles */
        .mud-container {
            background-color: #000;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            padding: 1rem;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }

        .container-header {
            color: #ffff00;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .container-line {
            margin-bottom: 0.1rem;
            color: #00ff00;
            padding-left: 0.5rem;
        }

        .inventory-line {
            margin-bottom: 0.2rem;
            color: #00ff00;
        }

        /* Tabs */
        .nav-pills .nav-link {
            background: var(--accent-bg);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            margin-right: 0.5rem;
        }

        .nav-pills .nav-link.active {
            background: var(--accent-color);
            border-color: var(--accent-color);
            color: white;
        }

        /* Stats badges */
        .stat-badge {
            background: var(--accent-bg);
            border: 1px solid var(--border-color);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .gold-amount {
            color: #ffd700;
            font-weight: 600;
        }
        
        /* Score Display Styles */
        .score-display {
            background: #0a0a0a;
            border: 2px solid #333;
            border-radius: 4px;
            padding: 1.5rem;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            color: #c0c0c0;
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.5);
        }
        
        .score-content {
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            background: rgba(0, 0, 0, 0.95);
            color: #e0e0e0;
            padding: 1.5rem;
            border-radius: 8px;
            border: 2px solid #444;
            line-height: 1.6;
            font-size: 0.9rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .raw-score .score-row {
            margin: 0.4rem 0;
            padding: 0.2rem 0;
            font-family: 'Courier New', monospace;
            white-space: pre;
        }
        
        .stats-row {
            color: #c0c0c0;
            border-left: 3px solid #444;
            padding-left: 0.5rem;
            margin: 0.2rem 0;
        }
        
        /* Enhanced class-specific colors */
        .class-warrior { color: #ff6b6b !important; font-weight: bold; }
        .class-cleric { color: #ffd93d !important; font-weight: bold; }
        .class-mage { color: #4ecdc4 !important; font-weight: bold; }
        .class-thief { color: #a8e6cf !important; font-weight: bold; }
        .class-druid { color: #88d8b0 !important; font-weight: bold; }
        .class-ranger { color: #77dd77 !important; font-weight: bold; }
        .class-paladin { color: #ffb3ba !important; font-weight: bold; }
        .class-antipaladin { color: #ff6961 !important; font-weight: bold; }
        .class-barbarian { color: #ffb347 !important; font-weight: bold; }
        .class-monk { color: #dda0dd !important; font-weight: bold; }
        .class-vampire { color: #800020 !important; font-weight: bold; }
        .class-augurer { color: #87ceeb !important; font-weight: bold; }
        .class-nephandi { color: #9370db !important; font-weight: bold; }
        
        /* Enhanced value highlighting */
        .gold-value { 
            color: #ffd700 !important; 
            font-weight: bold;
            text-shadow: 0 0 3px #ffd700;
        }
        .glory-value { 
            color: #ff69b4 !important; 
            font-weight: bold;
        }
        .hp-value { 
            color: #32cd32 !important; 
            font-weight: bold;
        }
        .combat-stat {
            color: #ff8c00 !important;
            font-weight: bold;
        }
        .race-name {
            color: #dda0dd !important;
            font-weight: bold;
        }
        .deity-name {
            color: #87ceeb !important;
            font-weight: bold;
            text-shadow: 0 0 2px #87ceeb;
        }
        .alignment-value {
            color: #daa520 !important;
            font-weight: bold;
        }
        
        /* Stat formatting */
        .stat-name { color: #b0b0b0; font-weight: bold; }
        .stat-current { color: #ffffff; font-weight: bold; }
        .stat-base { color: #888; }
        
        /* ANSI-style Map Styling */
        .house-map {
            padding: 1rem;
            background: #000;
            border-radius: 8px;
            border: 2px solid #444;
            font-family: 'Courier New', monospace;
        }
        
        .ansi-map {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .map-grid {
            display: inline-block;
            background: #111;
            padding: 1rem;
            border: 1px solid #333;
        }
        
        .map-row {
            display: flex;
        }
        
        .map-cell {
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            font-size: 24px;
            color: #888;
        }
        
        .room-cell {
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .room-box {
            position: absolute;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #222;
            border: 2px solid #666;
            border-radius: 4px;
            font-size: 20px;
            color: #fff;
            z-index: 2;
        }
        
        .room-cell:hover .room-box {
            background: #333;
            border-color: var(--magic-glow);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
        
        .room-cell.start-room .room-box {
            background: rgba(255, 215, 0, 0.2);
            border-color: var(--magic-glow);
            color: var(--magic-glow);
        }
        
        .room-cell.selected-room .room-box {
            background: rgba(100, 149, 237, 0.3);
            border-color: #6495ed;
            box-shadow: 0 0 15px rgba(100, 149, 237, 0.7);
        }
        
        .room-label {
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: #aaa;
            text-align: center;
            white-space: nowrap;
            z-index: 3;
            background: rgba(0, 0, 0, 0.8);
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        .start-room .room-label {
            color: var(--magic-glow);
            font-weight: bold;
        }
        
        /* Connection lines */
        .connection {
            position: absolute;
            color: #666;
            font-size: 20px;
            line-height: 1;
        }
        
        .connection.north {
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .connection.south {
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .connection.east {
            right: -10px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .connection.west {
            left: -10px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .empty-cell {
            color: #444;
            font-size: 16px;
        }
        
        /* Map Legend */
        .map-legend {
            margin-top: 1rem;
            padding: 0.5rem;
            background: rgba(40, 40, 40, 0.5);
            border-radius: 4px;
            display: flex;
            gap: 2rem;
            justify-content: center;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #aaa;
            font-size: 0.9rem;
        }
        
        .legend-symbol {
            color: var(--magic-glow);
            font-weight: bold;
        }
        
        .house-rooms {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .room-node {
            background: rgba(30, 30, 30, 0.95);
            border: 2px solid #555;
            border-radius: 8px;
            padding: 1rem;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .room-node:hover {
            border-color: var(--magic-glow);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
            transform: translateY(-2px);
        }
        
        .start-room {
            border-color: var(--magic-glow) !important;
            background: rgba(40, 40, 20, 0.95);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.2);
        }
        
        .start-room::before {
            content: "🏠";
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--magic-glow);
            color: #000;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        .room-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 0.5rem;
            gap: 1rem;
        }
        
        .room-name {
            color: var(--text-primary);
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
            flex: 1;
        }
        
        .room-path {
            color: var(--magic-glow);
            background: rgba(255, 215, 0, 0.1);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-family: monospace;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        
        .room-containers {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .container-tag {
            background: rgba(100, 149, 237, 0.2);
            color: #6495ed;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            border: 1px solid rgba(100, 149, 237, 0.4);
        }
        
        .no-containers {
            color: var(--text-secondary);
            font-style: italic;
            font-size: 0.8rem;
        }
        
        /* Depth-based indentation */
        .depth-1 { margin-left: 2rem; border-left: 3px solid #666; }
        .depth-2 { margin-left: 4rem; border-left: 3px solid #777; }
        .depth-3 { margin-left: 6rem; border-left: 3px solid #888; }
        .depth-4 { margin-left: 8rem; border-left: 3px solid #999; }
        .depth-5 { margin-left: 10rem; border-left: 3px solid #aaa; }
        
        /* House Inventory Table Styling */
        .house-inventory-list {
            padding: 0.5rem 0;
        }
        
        .filter-indicator {
            background: rgba(100, 149, 237, 0.1);
            border: 1px solid #6495ed;
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .container-section {
            margin-bottom: 2rem;
            background: rgba(20, 20, 20, 0.4);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #333;
        }
        
        .container-header {
            background: rgba(40, 40, 40, 0.8);
            padding: 0.75rem 1rem;
            margin: 0;
            border-bottom: 2px solid var(--magic-glow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-primary);
        }
        
        .item-count {
            background: rgba(255, 215, 0, 0.2);
            color: var(--magic-glow);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .container-items-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .container-items-table thead {
            background: rgba(30, 30, 30, 0.6);
        }
        
        .container-items-table th {
            padding: 0.5rem 1rem;
            text-align: left;
            color: #aaa;
            font-weight: 600;
            border-bottom: 1px solid #444;
        }
        
        .container-items-table tbody tr {
            transition: background 0.2s;
        }
        
        .container-items-table tbody tr:hover {
            background: rgba(255, 215, 0, 0.05);
        }
        
        .container-items-table td {
            padding: 0.5rem 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .item-name-cell {
            color: var(--text-primary);
        }
        
        .item-quantity-cell {
            text-align: center;
            color: var(--magic-glow);
            font-weight: bold;
        }
        
        /* MUD Item Color - Equipment Green */
        .item-mud {
            color: #32cd32 !important;  /* Same green as equipment */
        }
        
        /* ANSI Color Support - Standard 16 colors */
        .ansi-black { color: #000000; }
        .ansi-red { color: #800000; }
        .ansi-green { color: #008000; }
        .ansi-yellow { color: #808000; }
        .ansi-blue { color: #000080; }
        .ansi-magenta { color: #800080; }
        .ansi-cyan { color: #008080; }
        .ansi-white { color: #c0c0c0; }
        .ansi-bright-black { color: #808080; }
        .ansi-bright-red { color: #ff0000; }
        .ansi-bright-green { color: #00ff00; }
        .ansi-bright-yellow { color: #ffff00; }
        .ansi-bright-blue { color: #0000ff; }
        .ansi-bright-magenta { color: #ff00ff; }
        .ansi-bright-cyan { color: #00ffff; }
        .ansi-bright-white { color: #ffffff; }
        
        /* ANSI Background Colors */
        .ansi-bg-black { background-color: #000000; }
        .ansi-bg-red { background-color: #800000; }
        .ansi-bg-green { background-color: #008000; }
        .ansi-bg-yellow { background-color: #808000; }
        .ansi-bg-blue { background-color: #000080; }
        .ansi-bg-magenta { background-color: #800080; }
        .ansi-bg-cyan { background-color: #008080; }
        .ansi-bg-white { background-color: #c0c0c0; }
        .ansi-bg-bright-black { background-color: #808080; }
        .ansi-bg-bright-red { background-color: #ff0000; }
        .ansi-bg-bright-green { background-color: #00ff00; }
        .ansi-bg-bright-yellow { background-color: #ffff00; }
        .ansi-bg-bright-blue { background-color: #0000ff; }
        .ansi-bg-bright-magenta { background-color: #ff00ff; }
        .ansi-bg-bright-cyan { background-color: #00ffff; }
        .ansi-bg-bright-white { background-color: #ffffff; }
        
        /* ANSI Text Styling */
        .ansi-bold { font-weight: bold; }
        .ansi-underline { text-decoration: underline; }
        .ansi-italic { font-style: italic; }
        
        /* Room containers section */
        .room-containers-section {
            margin-bottom: 2rem;
        }
        
        .room-name-header {
            color: var(--magic-glow);
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid rgba(255, 215, 0, 0.3);
        }
        
        /* For Sale checkbox styling in house containers */
        .container-line {
            display: flex;
            align-items: center;
            margin: 0.2rem 0;
        }
        
        .for-sale-checkbox {
            flex-shrink: 0;
            margin-right: 0.5rem;
            transform: scale(1.1);
            cursor: pointer;
        }
        
        .for-sale-checkbox:checked + .item-line-text {
            background: rgba(255, 215, 0, 0.1);
            border-radius: 3px;
            padding: 0 0.25rem;
        }
        
        .item-line-text {
            color: #32cd32;
            font-family: 'Courier New', monospace;
            flex: 1;
        }
        
        /* For Sale label styling */
        .for-sale-label {
            display: inline-block;
            font-size: 0.8rem;
            color: var(--magic-glow);
            background: rgba(255, 215, 0, 0.1);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            border: 1px solid rgba(255, 215, 0, 0.3);
            font-weight: normal;
            margin-right: 1rem;
        }
        
        /* Legacy inventory location styling */
        .inventory-location {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: rgba(20, 20, 20, 0.6);
            border-radius: 8px;
            border-left: 4px solid var(--magic-glow);
        }
        
        .location-header {
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
        }
        
        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.5rem;
        }
        
        .item-card {
            background: rgba(40, 40, 40, 0.8);
            padding: 0.5rem;
            border-radius: 6px;
            border: 1px solid #555;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .item-name {
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        
        .item-quantity {
            color: var(--magic-glow);
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .score-header {
            color: #ffffff;
            font-weight: bold;
            text-align: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #444;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .score-row {
            margin-bottom: 0.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 2rem;
        }
        
        .score-label {
            color: #808080;
            font-weight: bold;
            margin-right: 0.5rem;
        }
        
        .score-value {
            color: #ffffff;
        }
        
        /* Special value colors */
        .score-value.gold-value {
            color: #ffd700;
            font-weight: bold;
        }
        
        .score-value.glory-value {
            color: #ff69b4;
            font-weight: bold;
        }
        
        .score-value.hp-value {
            color: #ff4444;
            font-weight: bold;
        }
        
        /* Class colors matching the game */
        .score-value.class-mage { color: #00ffff; }
        .score-value.class-cleric { color: #ffffff; }
        .score-value.class-thief { color: #ffff00; }
        .score-value.class-warrior { color: #d2691e; }
        .score-value.class-vampire, .score-value.class-dread { color: #ff6b6b; }
        .score-value.class-druid { color: #00ff00; }
        .score-value.class-ranger { color: #32cd32; }
        .score-value.class-augurer { color: #b0b0b0; }
        .score-value.class-paladin { color: #ffb6c1; }
        .score-value.class-nephandi { color: #9400d3; }
        .score-value.class-fathomer { color: #5f9ea0; }
        .score-value.class-bladesinger { color: #cd5c5c; }
        .score-value.class-barbarian { color: #ffa500; }
        
        /* Alignment colors */
        .score-value.align-good {
            color: #00ff00;
        }
        
        .score-value.align-evil {
            color: #ff0000;
        }
        
        .score-value.align-neutral {
            color: #ffff00;
        }
        
        /* Raw score specific styling */
        .raw-score {
            white-space: pre;
            font-size: 13px;
        }

        /* Class color coding */
        .class-mage { color: #00FFFF; } /* Cyan */
        .class-cleric { color: #FFFFFF; } /* White */
        .class-thief { color: #FFFF00; } /* Yellow */
        .class-warrior { color: #8B4513; } /* Brown */
        .class-vampire { color: #FF0000; } /* Bright Red */
        .class-druid { color: #00FF00; } /* Green */
        .class-ranger { color: #228B22; } /* Forest Green */
        .class-augurer { color: #808080; } /* Gray */
        .class-paladin { color: #FFB6C1; } /* Pink */
        .class-nephandi { color: #9400D3; } /* Purple */
        .class-fathomer { color: #4682B4; } /* Ocean Blue */
        .class-bladesinger { color: #CD5C5C; } /* Dull Red */
        .class-barbarian { color: #FFA500; } /* Orange */

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--accent-bg);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* Loading state */
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
        }

        .spinner {
            border: 2px solid var(--border-color);
            border-top: 2px solid var(--accent-color);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Enhanced dashboard styling */
        .enhanced-navbar {
            background: linear-gradient(to bottom, var(--secondary-bg), rgba(20, 25, 37, 0.95)) !important;
            border-bottom: 2px solid var(--accent-color);
            box-shadow: 0 4px 20px rgba(124, 58, 237, 0.15);
            backdrop-filter: blur(10px);
            margin-bottom: 0;
        }
        
        .enhanced-sidebar-header {
            background: linear-gradient(135deg, var(--accent-bg), var(--border-color));
            border-bottom: 2px solid var(--accent-color);
        }
        
        .character-card {
            background: linear-gradient(135deg, var(--accent-bg), var(--secondary-bg));
            border: 1px solid var(--border-color);
            border-radius: 10px;
            margin-bottom: 1rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .character-card::before {
            content: '';
            position: absolute;
            top: -1px;
            left: -1px;
            right: -1px;
            bottom: -1px;
            background: linear-gradient(45deg, var(--accent-color), var(--magic-glow));
            border-radius: 10px;
            opacity: 0;
            z-index: -1;
            transition: opacity 0.3s ease;
        }
        
        .character-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(124, 58, 237, 0.2);
        }
        
        .character-card:hover::before {
            opacity: 0.3;
        }
        
        .character-card.active {
            border-color: var(--accent-color);
            background: linear-gradient(135deg, var(--secondary-bg), var(--accent-bg));
            box-shadow: 0 4px 20px rgba(124, 58, 237, 0.3);
        }
        
        .character-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-family: 'Cinzel', serif;
        }
        
        .detail-card {
            background: linear-gradient(135deg, var(--secondary-bg), var(--accent-bg));
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }
        
        .detail-card-header {
            padding: 1rem 1.5rem;
            border-bottom: 2px solid var(--accent-color);
            background: linear-gradient(135deg, var(--accent-bg), var(--border-color));
            border-radius: 12px 12px 0 0;
            color: var(--text-primary);
        }
        
        .detail-card-header h4 {
            font-family: 'Cinzel', serif;
            font-weight: 600;
            margin: 0;
        }
        
        .enhanced-back-btn {
            background: linear-gradient(45deg, var(--accent-bg), var(--border-color));
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            font-weight: 600;
            padding: 0.5rem 1.5rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            text-decoration: none;
        }
        
        .enhanced-back-btn:hover {
            background: linear-gradient(45deg, var(--border-color), var(--accent-color));
            border-color: var(--accent-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
        }
        
        /* Enhanced scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--primary-bg);
            border-radius: 6px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(to bottom, var(--accent-color), var(--magic-glow));
            border-radius: 6px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--magic-glow);
        }
        
        /* Enhanced MUD terminal */
        .mud-terminal {
            background-color: #000;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            padding: 1.5rem;
            border-radius: 8px;
            border: 2px solid var(--accent-color);
            box-shadow: inset 0 0 20px rgba(124, 58, 237, 0.1);
            max-height: 600px;
            overflow-y: auto;
            font-size: 0.875rem;
            line-height: 1.4;
        }
        
        .mud-header {
            color: var(--magic-glow);
            font-weight: bold;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
            font-size: 1.1rem;
        }
        
        .equipment-slot-mud {
            color: var(--gold-color);
            min-width: 200px;
            display: inline-block;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg enhanced-navbar">
        <div class="container-fluid">
            <a class="navbar-brand" href="/" style="font-family: 'Cinzel', serif; font-weight: 600; font-size: 1.5rem; letter-spacing: 0.05em; color: var(--text-primary) !important;">
                <i class="fas fa-scroll me-2" style="color: var(--magic-glow);"></i>
                <span style="background: linear-gradient(45deg, var(--accent-color), var(--magic-glow)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Malfian's Vault</span>
                <small style="display: block; font-size: 0.65rem; font-family: 'Crimson Text', serif; letter-spacing: 0.1em; color: var(--text-secondary); margin-top: -0.2rem;">Realms of Despair Manager</small>
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/" style="color: var(--text-secondary) !important;">
                    <i class="fas fa-users me-1"></i> Heroes
                </a>
                <a class="nav-link active" href="/dashboard" style="color: var(--accent-color) !important;">
                    <i class="fas fa-user-circle me-1"></i> Character
                </a>
                <a class="nav-link" href="/consolidated-inventory" style="color: var(--text-secondary) !important;">
                    <i class="fas fa-treasure-chest me-1"></i> Treasury
                </a>
                <a class="nav-link" href="/containers" style="color: var(--text-secondary) !important;">
                    <i class="fas fa-cogs me-1"></i> Containers
                </a>
                <a class="nav-link" href="/reload" onclick="reloadData(event)" style="color: var(--text-secondary) !important;">
                    <i class="fas fa-sync-alt me-1"></i> Refresh
                </a>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header enhanced-sidebar-header">
                <h3 class="mb-0" style="font-family: 'Cinzel', serif; font-weight: 600; color: var(--text-primary);">
                    <i class="fas fa-users me-2" style="color: var(--accent-color);"></i>
                    Heroes
                </h3>
                <p class="mb-0 mt-1" style="color: var(--text-secondary); font-style: italic;">Select a character to view their realm</p>
            </div>
            
            <div class="character-list" id="characterList">
                <div class="loading">
                    <div class="spinner"></div>
                    Loading characters...
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="content-header">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <h1 class="mb-0" id="mainTitle" style="font-family: 'Cinzel', serif; font-weight: 700; color: var(--text-primary);">
                            <i class="fas fa-scroll me-2" style="color: var(--magic-glow);"></i>
                            Character Archive
                        </h1>
                        <p class="mb-0 mt-1" id="mainSubtitle" style="color: var(--text-secondary); font-style: italic;">Select a character from the sidebar to explore their inventory and equipment</p>
                    </div>
                    <a href="/" class="btn enhanced-back-btn" id="backButton" style="display: none;">
                        <i class="fas fa-arrow-left me-2"></i>Back to Heroes
                    </a>
                </div>
            </div>
            
            <div class="content-body">
                <div id="welcomeMessage">
                    <div class="text-center" style="margin-top: 4rem;">
                        <i class="fas fa-scroll fa-4x mb-3" style="color: var(--text-secondary); opacity: 0.5;"></i>
                        <h3 style="color: var(--text-primary); font-family: 'Cinzel', serif; font-weight: 600;">Welcome to Malfian's Vault</h3>
                        <p style="color: var(--text-secondary);">Select a hero from the sidebar to explore their legend</p>
                    </div>
                </div>
                
                <!-- Character Details Template -->
                <div id="characterDetails" class="character-details">
                    <!-- Content will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let characters = [];
        let characterData = {};
        let currentCharacter = null;

        // Load character list
        async function loadCharacters() {
            try {
                const response = await fetch('/api/characters');
                characters = await response.json();
                renderCharacterList();
                loadCharacterStats();
            } catch (error) {
                console.error('Error loading characters:', error);
                document.getElementById('characterList').innerHTML = 
                    '<div class="text-center text-danger"><i class="fas fa-exclamation-triangle"></i> Error loading characters</div>';
            }
        }

        // Parse house layout from room data and build grid positions
        function parseHouseLayout(roomsString) {
            const rooms = roomsString.split('|');
            const houseData = {
                rooms: [],
                layout: new Map(),
                startRoom: null,
                grid: new Map() // Store grid positions
            };
            
            // Manually position rooms for Kaan's house to create inverted T shape
            // This is based on the actual room connections:
            // Manse (start) -> down -> Madness -> down -> Base -> south -> Alchemy
            //                                        Base -> north -> Vault (goes north from Base)
            
            let minX = 0, maxX = 0, minY = 0, maxY = 0;
            
            rooms.forEach((roomString, index) => {
                const [roomName, path, containers] = roomString.split(':');
                const room = {
                    name: roomName.trim(),
                    path: path.trim(),
                    containers: containers ? containers.split(',').map(c => c.trim()) : [],
                    isStart: path === 'start',
                    x: 0,
                    y: 0,
                    level: 0 // Track vertical level
                };
                
                // Manually set positions based on the known layout
                if (room.isStart) {
                    // Manse of the Macabre - top center
                    houseData.startRoom = room.name;
                    room.x = 0;
                    room.y = 0;
                    room.level = 0;
                } else if (room.name.includes('Madness')) {
                    // Madness Below - directly below start
                    room.x = 0;
                    room.y = 1;
                    room.level = -1;
                } else if (room.name.includes('Base') || room.name.includes('Pit')) {
                    // Base of the Pit - center of the T
                    room.x = 0;
                    room.y = 2;
                    room.level = -2;
                } else if (room.name.includes('Alchemy')) {
                    // Alchemy Laboratory - to the right of Base (right arm of inverted T)
                    room.x = 1;
                    room.y = 2;
                    room.level = -2;
                } else if (room.name.includes('Vault')) {
                    // Vault of the Elders - to the left of Base (left arm of inverted T)
                    room.x = -1;
                    room.y = 2;
                    room.level = -2;
                }
                
                minX = Math.min(minX, room.x);
                maxX = Math.max(maxX, room.x);
                minY = Math.min(minY, room.y);
                maxY = Math.max(maxY, room.y);
                
                houseData.rooms.push(room);
                houseData.layout.set(room.name, room);
            });
            
            // Normalize positions to start from 0,0
            houseData.rooms.forEach(room => {
                room.x -= minX;
                room.y -= minY;
                houseData.grid.set(`${room.x},${room.y}`, room);
            });
            
            houseData.width = maxX - minX + 1;
            houseData.height = maxY - minY + 1;
            
            return houseData;
        }
        
        // Calculate room position from movement path
        function calculateRoomPosition(path) {
            let x = 0, y = 0;
            if (path === 'start') return {x, y};
            
            const moves = path.split(';');
            moves.forEach(move => {
                switch(move.trim()) {
                    case 'n': y--; break;  // North goes up
                    case 's': y++; break;  // South goes down
                    case 'e': x++; break;  // East goes right
                    case 'w': x--; break;  // West goes left
                    case 'u': break;       // Up doesn't change map position (vertical level)
                    case 'd': break;       // Down doesn't change map position (vertical level)
                    case 'ne': x++; y--; break;
                    case 'nw': x--; y--; break;
                    case 'se': x++; y++; break;
                    case 'sw': x--; y++; break;
                }
            });
            
            return {x, y};
        }
        
        // Render house layout visualization
        function renderHouseDetails(data, houseLayout) {
            // Store containers globally for filtering
            window.currentHouseContainers = data.containers;
            
            const container = document.getElementById('characterDetails');
            container.innerHTML = `
                <!-- House Layout -->
                <div class="detail-card">
                    <div class="detail-card-header">
                        <h5 class="mb-0"><i class="fas fa-home me-2"></i>House Map: ${data.house_name || data.character}</h5>
                    </div>
                    <div class="detail-card-body">
                        <div class="house-map">
                            ${renderHouseMap(houseLayout)}
                        </div>
                    </div>
                </div>
                
                <!-- House Inventory -->
                <div class="detail-card">
                    <div class="detail-card-header">
                        <h5 class="mb-0"><i class="fas fa-boxes me-2"></i>Storage Containers (${getTotalItemCount(data.containers)} items)</h5>
                    </div>
                    <div class="detail-card-body house-inventory-content">
                        ${data.containers && Object.keys(data.containers).length > 0 ? renderHouseInventoryFromContainers(data.containers) : '<p class="text-muted">No items found in house storage.</p>'}
                    </div>
                </div>
            `;
            
            // Make filter functions globally accessible
            window.filterRoomInventory = filterRoomInventory;
            window.clearRoomFilter = clearRoomFilter;
            window.toggleForSale = toggleForSale;
        }
        
        // Render ANSI-style grid map
        function renderHouseMap(houseLayout) {
            if (!houseLayout.grid || houseLayout.grid.size === 0) {
                return '<div class="no-map">No map data available</div>';
            }
            
            let mapHtml = '<div class="ansi-map">';
            mapHtml += '<div class="map-grid">';
            
            // Create the grid
            for (let y = 0; y < houseLayout.height; y++) {
                mapHtml += '<div class="map-row">';
                for (let x = 0; x < houseLayout.width; x++) {
                    const room = houseLayout.grid.get(`${x},${y}`);
                    if (room) {
                        // Check connections to adjacent rooms
                        const connections = getConnections(x, y, houseLayout);
                        mapHtml += `
                            <div class="map-cell room-cell ${room.isStart ? 'start-room' : ''}" 
                                 data-room="${room.name}"
                                 data-containers="${room.containers.join(', ')}"
                                 title="${room.name}">
                                <div class="room-box" onclick="filterRoomInventory('${room.name.replace(/'/g, "\\'")}')">
                                    ${room.isStart ? '⌂' : '□'}
                                </div>
                                ${connections}
                                <div class="room-label">${room.name.split(' ').slice(0, 2).join(' ')}</div>
                            </div>
                        `;
                    } else {
                        // Empty cell - check if it should have connection lines
                        const lineType = getConnectionLine(x, y, houseLayout);
                        mapHtml += `<div class="map-cell empty-cell">${lineType}</div>`;
                    }
                }
                mapHtml += '</div>';
            }
            
            mapHtml += '</div>';
            
            // Add legend
            mapHtml += `
                <div class="map-legend">
                    <div class="legend-item"><span class="legend-symbol">⌂</span> Starting Room</div>
                    <div class="legend-item"><span class="legend-symbol">□</span> Room</div>
                    <div class="legend-item"><span class="legend-symbol">─│┌┐└┘├┤┬┴┼</span> Connections</div>
                </div>
            `;
            
            mapHtml += '</div>';
            return mapHtml;
        }
        
        // Get connection symbols for a room
        function getConnections(x, y, houseLayout) {
            let connections = '';
            const hasNorth = houseLayout.grid.has(`${x},${y-1}`);
            const hasSouth = houseLayout.grid.has(`${x},${y+1}`);
            const hasEast = houseLayout.grid.has(`${x+1},${y}`);
            const hasWest = houseLayout.grid.has(`${x-1},${y}`);
            
            if (hasNorth) connections += '<div class="connection north">│</div>';
            if (hasSouth) connections += '<div class="connection south">│</div>';
            if (hasEast) connections += '<div class="connection east">─</div>';
            if (hasWest) connections += '<div class="connection west">─</div>';
            
            return connections;
        }
        
        // Get connection line type for empty cells
        function getConnectionLine(x, y, houseLayout) {
            // Check if this empty cell is between two rooms
            const hasNorth = houseLayout.grid.has(`${x},${y-1}`);
            const hasSouth = houseLayout.grid.has(`${x},${y+1}`);
            const hasEast = houseLayout.grid.has(`${x+1},${y}`);
            const hasWest = houseLayout.grid.has(`${x-1},${y}`);
            
            // Vertical line
            if (hasNorth && hasSouth) return '│';
            // Horizontal line
            if (hasEast && hasWest) return '─';
            // Corners and junctions
            if (hasNorth && hasEast) return '└';
            if (hasNorth && hasWest) return '┘';
            if (hasSouth && hasEast) return '┌';
            if (hasSouth && hasWest) return '┐';
            
            return '';
        }
        
        // Render individual room node
        function renderRoomNode(room, depth, isStart) {
            const depthClass = `depth-${Math.min(depth, 5)}`;
            const startClass = isStart ? 'start-room' : '';
            const pathDisplay = isStart ? 'START' : formatPath(room.path);
            
            return `
                <div class="room-node ${depthClass} ${startClass}">
                    <div class="room-header">
                        <h6 class="room-name">${room.name}</h6>
                        <span class="room-path">${pathDisplay}</span>
                    </div>
                    <div class="room-containers">
                        ${room.containers.length > 0 ? 
                            room.containers.map(container => `<span class="container-tag">${container}</span>`).join('') :
                            '<span class="no-containers">No containers</span>'
                        }
                    </div>
                </div>
            `;
        }
        
        // Get path depth for positioning
        function getPathDepth(path) {
            if (path === 'start') return 0;
            return (path.match(/[;]/g) || []).length + 1;
        }
        
        // Format path display
        function formatPath(path) {
            if (path === 'start') return 'START';
            return path.split(';').join(' → ');
        }
        
        // Get total item count from containers
        function getTotalItemCount(containers) {
            if (!containers) return 0;
            return Object.values(containers).reduce((total, items) => total + items.length, 0);
        }
        
        // Convert ANSI escape codes to HTML with CSS classes
        function ansiToHtml(text) {
            if (!text || typeof text !== 'string') return text;
            
            // ANSI color code mappings
            const colorMap = {
                '30': 'ansi-black', '31': 'ansi-red', '32': 'ansi-green', '33': 'ansi-yellow',
                '34': 'ansi-blue', '35': 'ansi-magenta', '36': 'ansi-cyan', '37': 'ansi-white',
                '90': 'ansi-bright-black', '91': 'ansi-bright-red', '92': 'ansi-bright-green',
                '93': 'ansi-bright-yellow', '94': 'ansi-bright-blue', '95': 'ansi-bright-magenta',
                '96': 'ansi-bright-cyan', '97': 'ansi-bright-white'
            };
            
            const bgColorMap = {
                '40': 'ansi-bg-black', '41': 'ansi-bg-red', '42': 'ansi-bg-green', '43': 'ansi-bg-yellow',
                '44': 'ansi-bg-blue', '45': 'ansi-bg-magenta', '46': 'ansi-bg-cyan', '47': 'ansi-bg-white',
                '100': 'ansi-bg-bright-black', '101': 'ansi-bg-bright-red', '102': 'ansi-bg-bright-green',
                '103': 'ansi-bg-bright-yellow', '104': 'ansi-bg-bright-blue', '105': 'ansi-bg-bright-magenta',
                '106': 'ansi-bg-bright-cyan', '107': 'ansi-bg-bright-white'
            };
            
            const styleMap = {
                '1': 'ansi-bold',
                '3': 'ansi-italic',
                '4': 'ansi-underline'
            };
            
            let result = '';
            let currentClasses = new Set();
            let i = 0;
            
            while (i < text.length) {
                if (text[i] === '\x1b' && text[i + 1] === '[') {
                    // Found ANSI escape sequence
                    let j = i + 2;
                    while (j < text.length && text[j] !== 'm') {
                        j++;
                    }
                    
                    if (j < text.length) {
                        const codes = text.substring(i + 2, j).split(';');
                        
                        for (const code of codes) {
                            if (code === '0' || code === '') {
                                // Reset all formatting
                                currentClasses.clear();
                            } else if (colorMap[code]) {
                                // Remove any existing foreground color
                                for (const cls of currentClasses) {
                                    if (cls.startsWith('ansi-') && !cls.startsWith('ansi-bg-') && !cls.startsWith('ansi-bold') && !cls.startsWith('ansi-italic') && !cls.startsWith('ansi-underline')) {
                                        currentClasses.delete(cls);
                                    }
                                }
                                currentClasses.add(colorMap[code]);
                            } else if (bgColorMap[code]) {
                                // Remove any existing background color
                                for (const cls of currentClasses) {
                                    if (cls.startsWith('ansi-bg-')) {
                                        currentClasses.delete(cls);
                                    }
                                }
                                currentClasses.add(bgColorMap[code]);
                            } else if (styleMap[code]) {
                                currentClasses.add(styleMap[code]);
                            }
                        }
                        
                        i = j + 1;
                    } else {
                        result += text[i];
                        i++;
                    }
                } else {
                    // Regular character
                    if (currentClasses.size > 0) {
                        result += `<span class="${Array.from(currentClasses).join(' ')}">${escapeHtml(text[i])}</span>`;
                    } else {
                        result += escapeHtml(text[i]);
                    }
                    i++;
                }
            }
            
            return result;
        }
        
        // Escape HTML characters
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, (m) => map[m]);
        }
        
        // Format item names with ANSI colors preserved
        function formatItemName(itemName) {
            // Check if item has ANSI codes and convert them
            if (itemName && itemName.includes('\x1b[')) {
                return ansiToHtml(itemName);
            }
            // Fallback to green color for items without ANSI
            return `<span class="item-mud">${escapeHtml(itemName)}</span>`;
        }
        
        // Render house inventory from containers structure
        function renderHouseInventoryFromContainers(containers, filterRoom = null) {
            if (!containers) {
                return '<div class="text-center text-muted py-4">No containers found</div>';
            }
            
            let html = '';
            
            // Add filter indicator if filtering
            if (filterRoom) {
                html += `
                    <div class="filter-indicator">
                        <i class="fas fa-filter"></i> Showing items from: <strong>${filterRoom}</strong>
                        <button class="btn btn-sm btn-outline-secondary ms-2" onclick="clearRoomFilter()">
                            <i class="fas fa-times"></i> Clear Filter
                        </button>
                    </div>
                `;
            }
            
            // Group containers by room for better organization
            const containersByRoom = {};
            Object.entries(containers).forEach(([location, items]) => {
                const [roomName, containerName] = location.replace('house:', '').split(':');
                
                // Skip if filtering and doesn't match
                if (filterRoom && !roomName.includes(filterRoom)) {
                    return;
                }
                
                if (!containersByRoom[roomName]) {
                    containersByRoom[roomName] = {};
                }
                containersByRoom[roomName][containerName] = items;
            });
            
            // Render containers in MUD style like character containers
            Object.entries(containersByRoom).forEach(([roomName, roomContainers]) => {
                html += `<div class="room-containers-section">`;
                html += `<h6 class="room-name-header"><i class="fas fa-door-open me-2"></i>${roomName}</h6>`;
                
                Object.entries(roomContainers).forEach(([containerName, items]) => {
                    html += `
                        <div class="detail-card mb-3">
                            <div class="detail-card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-box me-2"></i>
                                    ${containerName.charAt(0).toUpperCase() + containerName.slice(1)} (${items.length} items)
                                </h5>
                            </div>
                            <div class="detail-card-body">
                                ${items.length > 0 ? `
                                    <div class="mud-container">
                                        <div class="container-header">
                                            <span class="for-sale-label">
                                                <i class="fas fa-store me-1"></i>For Sale
                                            </span>
                                            ${containerName} contains:
                                        </div>
                                        ${items.map(item => `
                                            <div class="container-line">
                                                <input type="checkbox" 
                                                       class="for-sale-checkbox me-2" 
                                                       data-item="${item.item_name}"
                                                       data-character="${item.character || 'house'}"
                                                       onchange="toggleForSale(this)"
                                                       title="Mark for sale">
                                                <span class="item-line-text">
                                                    ${formatItemName(item.raw_line || `${item.item_name}${item.quantity > 1 ? ` (${item.quantity})` : ''}`)}
                                                </span>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : '<div class="text-center text-muted py-3">This container is empty</div>'}
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            });
            
            return html || '<div class="text-center text-muted py-4">No items found</div>';
        }
        
        // Global variable to track filtered room
        let currentFilteredRoom = null;
        
        // Filter inventory by room
        function filterRoomInventory(roomName) {
            currentFilteredRoom = roomName;
            const inventoryContainer = document.querySelector('.house-inventory-content');
            if (inventoryContainer && window.currentHouseContainers) {
                inventoryContainer.innerHTML = renderHouseInventoryFromContainers(window.currentHouseContainers, roomName);
            }
            
            // Highlight selected room on map
            document.querySelectorAll('.room-cell').forEach(cell => {
                cell.classList.remove('selected-room');
                if (cell.getAttribute('data-room') === roomName) {
                    cell.classList.add('selected-room');
                }
            });
        }
        
        // Clear room filter
        function clearRoomFilter() {
            currentFilteredRoom = null;
            const inventoryContainer = document.querySelector('.house-inventory-content');
            if (inventoryContainer && window.currentHouseContainers) {
                inventoryContainer.innerHTML = renderHouseInventoryFromContainers(window.currentHouseContainers);
            }
            
            // Remove room highlighting
            document.querySelectorAll('.room-cell').forEach(cell => {
                cell.classList.remove('selected-room');
            });
        }
        
        // Toggle for sale status
        async function toggleForSale(checkbox) {
            const itemName = checkbox.dataset.item;
            const characterName = checkbox.dataset.character;
            const isForSale = checkbox.checked;
            
            try {
                const response = await fetch('/api/for-sale-items', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        item_name: itemName,
                        character: characterName,
                        for_sale: isForSale,
                        price: '' // Can be enhanced with price input later
                    })
                });
                
                if (response.ok) {
                    console.log(`${isForSale ? 'Added' : 'Removed'} "${itemName}" ${isForSale ? 'to' : 'from'} for sale list`);
                } else {
                    console.error('Failed to update for sale status');
                    // Revert checkbox if API call failed
                    checkbox.checked = !isForSale;
                }
            } catch (error) {
                console.error('Error updating for sale status:', error);
                // Revert checkbox if API call failed
                checkbox.checked = !isForSale;
            }
        }
        
        // Render house inventory (legacy function for backwards compatibility)
        function renderHouseInventory(inventory) {
            const grouped = {};
            inventory.forEach(item => {
                const location = item.location || 'Unknown';
                if (!grouped[location]) grouped[location] = [];
                grouped[location].push(item);
            });
            
            let html = '';
            Object.entries(grouped).forEach(([location, items]) => {
                html += `
                    <div class="inventory-location">
                        <h6 class="location-header">${location} (${items.length} items)</h6>
                        <div class="items-grid">
                            ${items.map(item => `
                                <div class="item-card">
                                    <span class="item-name">${formatItemName(item.item_name)}</span>
                                    ${item.quantity > 1 ? `<span class="item-quantity">(${item.quantity})</span>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            
            return html;
        }
        
        // Load house layout data
        async function loadHouseLayout(characterName, houseData) {
            try {
                // Extract the owner name from characterName (e.g., "Kaan_house" -> "Kaan")
                const ownerName = characterName.replace('_house', '');
                
                // For Kaan, use the known layout. In the future, this could be served by an API endpoint
                let houseLayoutString;
                if (ownerName.toLowerCase() === 'kaan') {
                    houseLayoutString = "Manse of the Macabre:start:reliquary,crate,shell|Madness Below:d:shell|Base of the Pit:d;d:crate,reliquary,shell|Alchemy Laboratory:d;d;s:shelf,rack,desk|Vault of the Elders:d;d;s;n;n:bin,box";
                } else {
                    // Default simple layout if no specific layout is defined
                    houseLayoutString = `${ownerName}'s House:start:chest,container`;
                }
                
                const houseLayout = parseHouseLayout(houseLayoutString);
                
                // Update the house data to include the proper house name
                houseData.house_name = houseData.house_name || `${ownerName}'s House`;
                
                renderHouseDetails(houseData, houseLayout);
            } catch (error) {
                console.error('Error loading house layout:', error);
                document.getElementById('characterDetails').innerHTML = '<div class="text-center text-danger">Error loading house layout</div>';
            }
        }

        // Load character stats
        async function loadCharacterStats() {
            try {
                const response = await fetch('/api/character-stats');
                const stats = await response.json();
                
                // Merge stats with character list (case-insensitive)
                characters.forEach(char => {
                    const stat = stats.find(s => s.character.toLowerCase() === char.toLowerCase());
                    if (stat) {
                        characterData[char] = stat;
                    } else {
                        characterData[char] = {
                            character: char,
                            class: 'Unknown',
                            race: 'Unknown',
                            gender: 'Unknown',
                            alignment: 'Unknown',
                            gold: '0',
                            level: 'Unknown'
                        };
                    }
                });
                
                renderCharacterList();
            } catch (error) {
                console.error('Error loading character stats:', error);
            }
        }

        // Render character list
        function renderCharacterList() {
            const container = document.getElementById('characterList');
            
            if (characters.length === 0) {
                container.innerHTML = '<div class="text-center text-muted">No characters found</div>';
                return;
            }

            container.innerHTML = characters.map(char => {
                const stats = characterData[char] || {};
                return `
                    <div class="character-card" data-character="${char}">
                        <div class="character-name">${char.charAt(0).toUpperCase() + char.slice(1)}</div>
                        <div class="character-stats">
                            <div class="stat-item">
                                <span class="stat-label">Class:</span> ${stats.class || 'Unknown'}
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Race:</span> ${stats.race || 'Unknown'}
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Level:</span> ${stats.level || 'Unknown'}
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Gold:</span> <span class="gold-amount">${formatNumber(stats.gold || '0')}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Gender:</span> ${stats.gender || 'Unknown'}
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Alignment:</span> ${stats.alignment || 'Unknown'}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Add click event listeners after rendering
            const cards = document.querySelectorAll('.character-card');
            console.log('Attaching click handlers to', cards.length, 'character cards');
            cards.forEach(card => {
                const characterName = card.getAttribute('data-character');
                console.log('Attaching handler for:', characterName);
                card.addEventListener('click', function() {
                    const name = this.getAttribute('data-character');
                    console.log('Card clicked:', name);
                    selectCharacter(name);
                });
            });
        }

        // Select character
        async function selectCharacter(characterName) {
            // Update active state
            document.querySelectorAll('.character-card').forEach(card => {
                card.classList.remove('active');
                if (card.onclick && card.onclick.toString().includes(characterName)) {
                    card.classList.add('active');
                }
            });

            currentCharacter = characterName;
            
            // Update header
            document.getElementById('mainTitle').innerHTML = `
                <i class="fas fa-user-ninja me-2"></i>
                ${characterName.charAt(0).toUpperCase() + characterName.slice(1)}
            `;
            document.getElementById('mainSubtitle').textContent = 'Loading character data...';

            // Hide welcome message and show back button
            document.getElementById('welcomeMessage').style.display = 'none';
            document.getElementById('backButton').style.display = 'inline-block';
            
            // Show loading in details
            const detailsContainer = document.getElementById('characterDetails');
            detailsContainer.innerHTML = '<div class="loading"><div class="spinner"></div>Loading character details...</div>';
            detailsContainer.classList.add('active');

            try {
                const response = await fetch(`/api/character/${characterName}`);
                const data = await response.json();
                
                // Debug logging
                console.log('Character data:', characterName, data);
                console.log('House detection:', {
                    hasHouseName: !!data.house_name,
                    includesHouse: characterName.includes("'s House"),
                    includesUnderscore: characterName.includes("_house")
                });
                
                // Check if this is house data by looking for house_name in the data or _house suffix
                if (data.house_name || characterName.includes("'s House") || characterName.includes("_house")) {
                    console.log('Detected as house, rendering house layout');
                    // This is a house, render house layout
                    document.getElementById('mainTitle').innerHTML = `
                        <i class="fas fa-home me-2"></i>
                        ${data.house_name || characterName}
                    `;
                    document.getElementById('mainSubtitle').textContent = 'House Layout and Storage';
                    
                    // Parse house layout from houses_v2.csv data (we'll need to load this)
                    loadHouseLayout(characterName, data);
                } else {
                    console.log('Detected as character, rendering character details');
                    // Regular character
                    renderCharacterDetails(data);
                }
            } catch (error) {
                console.error('Error loading character details:', error);
                detailsContainer.innerHTML = '<div class="text-center text-danger">Error loading character details</div>';
            }
        }

        // Render character details
        function renderCharacterDetails(data) {
            // Get character stats from our loaded data
            const stats = characterData[data.character] || {};
            
            document.getElementById('mainSubtitle').textContent = `${stats.class || 'Unknown'} • ${stats.race || 'Unknown'} • Level ${stats.level || 'Unknown'}`;

            const container = document.getElementById('characterDetails');
            container.innerHTML = `
                <!-- Character Score Display -->
                <div class="detail-card">
                    <div class="detail-card-header">
                        <h5 class="mb-0"><i class="fas fa-scroll me-2"></i>Character Score</h5>
                    </div>
                    <div class="detail-card-body p-0">
                        <div class="score-display">
                            ${formatScoreDisplay(stats)}
                        </div>
                    </div>
                </div>

                <!-- Navigation Tabs -->
                <ul class="nav nav-pills mb-3" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#equipment-tab">
                            <i class="fas fa-shield-alt me-1"></i>Equipment
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#inventory-tab">
                            <i class="fas fa-backpack me-1"></i>Inventory
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#containers-tab">
                            <i class="fas fa-boxes me-1"></i>Containers
                        </button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content">
                    <!-- Equipment Tab -->
                    <div class="tab-pane fade show active" id="equipment-tab">
                        <div class="detail-card">
                            <div class="detail-card-header">
                                <h5 class="mb-0"><i class="fas fa-shield-alt me-2"></i>Equipment (${data.equipment?.length || 0} items)</h5>
                            </div>
                            <div class="detail-card-body">
                                ${renderEquipment(data.equipment)}
                            </div>
                        </div>
                    </div>

                    <!-- Inventory Tab -->
                    <div class="tab-pane fade" id="inventory-tab">
                        <div class="detail-card">
                            <div class="detail-card-header">
                                <h5 class="mb-0"><i class="fas fa-backpack me-2"></i>Inventory (${data.inventory?.length || 0} items)</h5>
                            </div>
                            <div class="detail-card-body">
                                ${renderInventory(data.inventory)}
                            </div>
                        </div>
                    </div>

                    <!-- Containers Tab -->
                    <div class="tab-pane fade" id="containers-tab">
                        ${renderContainersConsolidated(data.containers)}
                    </div>
                </div>
            `;
        }

        // Render equipment only (no empty slots)
        function renderEquipmentOnly(equipment) {
            if (!equipment || equipment.length === 0) {
                return '<div class="text-center text-muted py-4">No equipment found</div>';
            }

            return `
                <div class="mud-terminal">
                    <div class="mud-header">You are using:</div>
                    ${equipment.map(item => `
                        <div class="mud-line">
                            <span class="equipment-slot-mud">&lt;${item.location.replace('equipped:', '')}&gt;</span>
                            <span class="item-text">${formatItemName(item.raw_line)}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Render equipment
        function renderEquipment(equipment) {
            // Define all equipment slots in order
            const allSlots = [
                'used as light', 'worn on finger', 'worn around neck', 'worn on body', 
                'worn on head', 'worn on legs', 'worn on feet', 'worn on hands', 
                'worn on arms', 'worn about body', 'worn about waist', 'worn around wrist',
                'wielded', 'dual wielded', 'worn as shield', 'held', 'worn on ears', 
                'worn on eyes', 'worn on back', 'worn over face', 'worn around ankle'
            ];
            
            // Create a map of equipped items by slot
            const equippedItems = {};
            if (equipment) {
                equipment.forEach(item => {
                    const slot = item.location.replace('equipped:', '');
                    if (!equippedItems[slot]) {
                        equippedItems[slot] = [];
                    }
                    equippedItems[slot].push(item);
                });
            }
            
            // Generate display with all slots, showing [nothing] for empty ones
            const equipmentLines = allSlots.map(slot => {
                if (equippedItems[slot] && equippedItems[slot].length > 0) {
                    // Show all items in this slot (some slots can have multiple items)
                    return equippedItems[slot].map(item => `
                        <div class="mud-line">
                            <span class="equipment-slot-mud">&lt;${slot}&gt;</span>
                            <span class="item-text">${formatItemName(item.raw_line)}</span>
                        </div>
                    `).join('');
                } else {
                    // Show empty slot
                    return `
                        <div class="mud-line">
                            <span class="equipment-slot-mud">&lt;${slot}&gt;</span>
                            <span class="item-text" style="color: #666; font-style: italic;">[nothing]</span>
                        </div>
                    `;
                }
            }).join('');

            return `
                <div class="mud-terminal">
                    <div class="mud-header">You are using:</div>
                    ${equipmentLines}
                </div>
            `;
        }

        // Render inventory
        function renderInventory(inventory) {
            if (!inventory || inventory.length === 0) {
                return '<div class="text-center text-muted py-4">No inventory items found</div>';
            }

            return `
                <div class="mud-terminal">
                    ${inventory.map(item => {
                        if (item.raw_line.includes('You are carrying') && item.raw_line.includes('items')) {
                            return `<div class="mud-header">${formatItemName(item.raw_line)}</div>`;
                        } else {
                            return `<div class="inventory-line">${formatItemName(item.raw_line)}</div>`;
                        }
                    }).join('')}
                </div>
            `;
        }

        // Render containers consolidated 
        function renderContainersConsolidated(containers) {
            if (!containers) {
                return '<div class="text-center text-muted py-4">No containers found</div>';
            }

            // Consolidate all container items
            const allContainerItems = [];
            Object.entries(containers).forEach(([containerName, items]) => {
                items.forEach(item => {
                    allContainerItems.push({
                        ...item,
                        container: containerName
                    });
                });
            });

            if (allContainerItems.length === 0) {
                return '<div class="text-center text-muted py-4">No container items found</div>';
            }

            const totalItems = allContainerItems.length;

            return `
                <div class="detail-card">
                    <div class="detail-card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-boxes me-2"></i>
                            Containers (${totalItems} items)
                        </h5>
                    </div>
                    <div class="detail-card-body">
                        <div class="mud-container">
                            <div class="container-header">Container contents:</div>
                            ${allContainerItems.map(item => `
                                <div class="container-line">
                                    <span style="color: #ffff00;">[${item.container.replace('my.', '')}]</span> ${formatItemName(item.raw_line)}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // Render containers
        function renderContainers(containers) {
            if (!containers) {
                return '<div class="text-center text-muted py-4">No containers found</div>';
            }

            return Object.entries(containers).map(([containerName, items]) => `
                <div class="detail-card">
                    <div class="detail-card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-box me-2"></i>
                            ${containerName.charAt(0).toUpperCase() + containerName.slice(1)} (${items.length} items)
                        </h5>
                    </div>
                    <div class="detail-card-body">
                        ${items.length > 0 ? `
                            <div class="mud-container">
                                <div class="container-header">${containerName} contains:</div>
                                ${items.map(item => `
                                    <div class="container-line">${formatItemName(item.raw_line)}</div>
                                `).join('')}
                            </div>
                        ` : '<div class="text-center text-muted py-3">This container is empty</div>'}
                    </div>
                </div>
            `).join('');
        }

        // Utility functions
        function formatNumber(num) {
            return parseInt(num || 0).toLocaleString();
        }
        
        function formatScoreDisplay(stats) {
            // If we have raw score output, parse and format it
            if (stats.raw_score) {
                return formatRawScore(stats.raw_score, stats);
            }
            
            // Otherwise, create a formatted display from parsed stats
            return `
                <div class="score-content">
                    <div class="score-header">
                        <span class="score-title">Score for ${stats.character || 'Unknown'}</span>
                    </div>
                    
                    <div class="score-row">
                        <span class="score-label">LEVEL:</span> <span class="score-value">${stats.level || '-'}</span>
                        <span class="score-label">Race:</span> <span class="score-value">${stats.race || '-'}</span>
                        <span class="score-label">Class:</span> <span class="score-value class-${(stats.class || '').toLowerCase()}">${stats.class || '-'}</span>
                    </div>
                    
                    <div class="score-row">
                        <span class="score-label">Age:</span> <span class="score-value">${stats.age || '-'}</span>
                        <span class="score-label">Gender:</span> <span class="score-value">${stats.gender || '-'}</span>
                        <span class="score-label">Deity:</span> <span class="score-value">${stats.deity || '-'}</span>
                    </div>
                    
                    <div class="score-row">
                        <span class="score-label">HP:</span> <span class="score-value hp-value">${stats.hitpoints || '-'}</span>
                        <span class="score-label">DR:</span> <span class="score-value">${stats.damroll || '-'}</span>
                        <span class="score-label">HR:</span> <span class="score-value">${stats.hitroll || '-'}</span>
                    </div>
                    
                    <div class="score-row">
                        <span class="score-label">Gold:</span> <span class="score-value gold-value">${formatNumber(stats.gold || 0)}</span>
                        <span class="score-label">Glory:</span> <span class="score-value glory-value">${formatNumber(stats.glory || 0)}</span>
                    </div>
                    
                    <div class="score-row">
                        <span class="score-label">Alignment:</span> <span class="score-value align-${getAlignmentClass(stats.alignment)}">${stats.alignment || '-'}</span>
                    </div>
                    
                    ${stats.order && stats.order !== '-' ? `
                    <div class="score-row">
                        <span class="score-label">Order:</span> <span class="score-value">${stats.order}</span>
                        ${stats.order_role && stats.order_role !== '-' ? `<span class="score-label">Role:</span> <span class="score-value">${stats.order_role}</span>` : ''}
                    </div>
                    ` : ''}
                    
                    ${stats.sect && stats.sect !== '-' ? `
                    <div class="score-row">
                        <span class="score-label">Sect:</span> <span class="score-value">${stats.sect}</span>
                        ${stats.sect_role && stats.sect_role !== '-' ? `<span class="score-label">Role:</span> <span class="score-value">${stats.sect_role}</span>` : ''}
                    </div>
                    ` : ''}
                    
                    ${stats.guild && stats.guild !== '-' ? `
                    <div class="score-row">
                        <span class="score-label">Guild:</span> <span class="score-value">${stats.guild}</span>
                        ${stats.guild_role && stats.guild_role !== '-' ? `<span class="score-label">Role:</span> <span class="score-value">${stats.guild_role}</span>` : ''}
                    </div>
                    ` : ''}
                </div>
            `;
        }
        
        function formatRawScore(rawScore, stats) {
            // Parse and format the raw score output into clean HTML
            let formatted = '<div class="score-content raw-score">';
            
            // Split by lines and process each
            const lines = rawScore.split('\n').filter(line => line.trim());
            
            lines.forEach(line => {
                // Clean up the line - strip ANSI codes and extra whitespace
                line = line.replace(/\x1b\[[0-9;]*m/g, '').trim();
                
                // Skip empty lines and prompts
                if (!line || line.includes('HTY\\') || line.includes('[') && line.includes('hp')) {
                    return;
                }
                
                // Format different types of score lines
                if (line.includes('Score for')) {
                    // Header line
                    formatted += `<div class="score-header">${line}</div>`;
                } else if (line.includes('LEVEL:') && line.includes('Race')) {
                    // LEVEL: 50          Race : Half-orc
                    formatted += `<div class="score-row">${formatMUDScoreLine(line, stats)}</div>`;
                } else if (line.includes('Class:')) {
                    // YEARS: 262         Class: Warrior
                    formatted += `<div class="score-row">${formatMUDScoreLine(line, stats)}</div>`;
                } else if (line.includes('Align:')) {
                    // DEX  : 21(14)      Align: +1000, devout
                    formatted += `<div class="score-row">${formatMUDScoreLine(line, stats)}</div>`;
                } else if (line.includes('Gold :')) {
                    // Gold : 17,737,804
                    formatted += `<div class="score-row">${formatMUDScoreLine(line, stats)}</div>`;
                } else if (line.includes('HitRoll:') || line.includes('DamRoll:')) {
                    // HitRoll: 70               Saved: no save this session
                    formatted += `<div class="score-row">${formatMUDScoreLine(line, stats)}</div>`;
                } else if (line.includes('Hitpoints:')) {
                    // Hitpoints: 1958  of  1958
                    formatted += `<div class="score-row">${formatMUDScoreLine(line, stats)}</div>`;
                } else if (line.includes('Glory:') || line.includes('Deity:') || line.includes('Order:')) {
                    // Glory: 0000(0000) or Deity: Tempus
                    formatted += `<div class="score-row">${formatMUDScoreLine(line, stats)}</div>`;
                } else if (line.includes('STR') || line.includes('INT') || line.includes('WIS') || 
                          line.includes('DEX') || line.includes('CON') || line.includes('CHA')) {
                    // Stats lines like: STR  : 21(18)      INT  : 17(17)
                    formatted += `<div class="score-row stats-row">${formatStatsLine(line)}</div>`;
                } else if (line.trim()) {
                    // Any other non-empty line
                    formatted += `<div class="score-row">${line}</div>`;
                }
            });
            
            formatted += '</div>';
            return formatted;
        }
        
        function formatMUDScoreLine(line, stats) {
            // Format MUD score lines with proper spacing and colors
            
            // Gold formatting with commas
            line = line.replace(/Gold\s*:\s*([0-9,]+)/g, 'Gold : <span class="gold-value">$1</span>');
            
            // Glory formatting 
            line = line.replace(/Glory\s*:\s*([0-9,()]+)/g, 'Glory: <span class="glory-value">$1</span>');
            
            // Hitpoints formatting
            line = line.replace(/Hitpoints\s*:\s*([0-9\s\/]+)/g, 'Hitpoints: <span class="hp-value">$1</span>');
            
            // HitRoll and DamRoll
            line = line.replace(/HitRoll\s*:\s*(\d+)/g, 'HitRoll: <span class="combat-stat">$1</span>');
            line = line.replace(/DamRoll\s*:\s*(\d+)/g, 'DamRoll: <span class="combat-stat">$1</span>');
            
            // Class highlighting with color
            if (stats.class) {
                const classRegex = new RegExp(`\\b${stats.class}\\b`, 'gi');
                line = line.replace(classRegex, `<span class="class-${stats.class.toLowerCase()}">$&</span>`);
            }
            
            // Race highlighting
            if (stats.race && stats.race !== 'Unknown') {
                const raceRegex = new RegExp(`\\b${stats.race}\\b`, 'gi');
                line = line.replace(raceRegex, `<span class="race-name">$&</span>`);
            }
            
            // Alignment formatting
            line = line.replace(/Align\s*:\s*([+-]?\d+[^,]*)/g, 'Align: <span class="alignment-value">$1</span>');
            
            // Deity highlighting
            line = line.replace(/Deity\s*:\s*(\w+)/g, 'Deity: <span class="deity-name">$1</span>');
            
            return line;
        }
        
        function formatStatsLine(line) {
            // Format ability score lines like: STR  : 21(18)      INT  : 17(17)
            // Add subtle highlighting to the current vs base stats
            line = line.replace(/(\w{3})\s*:\s*(\d+)\((\d+)\)/g, 
                '<span class="stat-name">$1</span> : <span class="stat-current">$2</span>(<span class="stat-base">$3</span>)');
            
            return line;
        }
        
        function getAlignmentClass(alignment) {
            if (!alignment) return 'neutral';
            const match = alignment.match(/([+-]?\d+)/);
            if (!match) return 'neutral';
            const value = parseInt(match[1]);
            if (value >= 500) return 'good';
            if (value <= -500) return 'evil';
            return 'neutral';
        }

        async function reloadData(event) {
            event.preventDefault();
            try {
                const response = await fetch('/reload');
                const result = await response.json();
                if (result.status === 'success') {
                    location.reload();
                }
            } catch (error) {
                console.error('Error reloading data:', error);
            }
        }

        // Get URL parameter
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            const charParam = getUrlParameter('char');
            
            if (charParam) {
                // Hide sidebar when viewing specific character
                document.querySelector('.sidebar').style.display = 'none';
                document.querySelector('.main-content').style.marginLeft = '0';
                
                // Load character data directly using the same selectCharacter function
                selectCharacter(charParam);
            } else {
                // Normal dashboard with sidebar
                loadCharacters();
            }
            
            // Test function accessibility
            window.selectCharacter = selectCharacter;
            console.log('selectCharacter function defined:', typeof selectCharacter);
        });

        // Load character directly without sidebar
        async function loadCharacterDirectly(characterName) {
            try {
                // Check if this is a house character (case insensitive)
                const isHouse = characterName.toLowerCase().endsWith('_house') || characterName.includes("'s House");
                
                if (isHouse) {
                    // Load house data
                    const ownerName = characterName.replace('_House', '');
                    
                    // Update header for house
                    document.getElementById('mainTitle').innerHTML = `
                        <i class="fas fa-home me-2"></i>
                        ${ownerName}'s House
                    `;
                    document.getElementById('mainSubtitle').textContent = 'House Storage • Property • House';
                    
                    // Hide welcome message and show back button
                    document.getElementById('welcomeMessage').style.display = 'none';
                    document.getElementById('backButton').style.display = 'inline-block';
                    
                    // Load house details
                    const response = await fetch(`/api/house/${ownerName}`);
                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    // Store house data for rendering
                    characterData[characterName] = {
                        character: characterName,
                        class: 'House Storage',
                        race: 'Property',
                        gender: 'Neutral',
                        alignment: 'Neutral',
                        is_house: true,
                        owner: ownerName
                    };
                    
                    renderCharacterDetails(data);
                    document.getElementById('characterDetails').classList.add('active');
                    
                } else {
                    // Regular character loading
                    // Load character stats for header info
                    const statsResponse = await fetch('/api/character-stats');
                    const allStats = await statsResponse.json();
                    const charStats = allStats.find(s => s.character.toLowerCase() === characterName.toLowerCase()) || {};
                    
                    // Update header immediately
                    document.getElementById('mainTitle').innerHTML = `
                        <i class="fas fa-user-ninja me-2"></i>
                        ${characterName.charAt(0).toUpperCase() + characterName.slice(1)}
                    `;
                    document.getElementById('mainSubtitle').textContent = `${charStats.class || 'Unknown'} • ${charStats.race || 'Unknown'} • Level ${charStats.level || 'Unknown'}`;
                    
                    // Hide welcome message and show back button
                    document.getElementById('welcomeMessage').style.display = 'none';
                    document.getElementById('backButton').style.display = 'inline-block';
                    
                    // Load character details
                    const response = await fetch(`/api/character/${characterName}`);
                    const data = await response.json();
                    
                    // Store character data for rendering
                    characterData[characterName] = charStats;
                    
                    renderCharacterDetails(data);
                    document.getElementById('characterDetails').classList.add('active');
                }
                
            } catch (error) {
                console.error('Error loading character:', error);
                document.getElementById('characterDetails').innerHTML = '<div class="text-center text-danger">Error loading character details</div>';
                document.getElementById('characterDetails').classList.add('active');
            }
        }
    </script>
</body>
</html>