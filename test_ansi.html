<!DOCTYPE html>
<html>
<head>
    <title>ANSI Test</title>
    <style>
        /* ANSI Color Classes for MUD Display */
        /* Standard ANSI Colors (30-37) */
        .ansi-black { color: #000000; }
        .ansi-red { color: #800000; }
        .ansi-green { color: #008000; }
        .ansi-yellow { color: #808000; }
        .ansi-blue { color: #000080; }
        .ansi-magenta { color: #800080; }
        .ansi-cyan { color: #008080; }
        .ansi-white { color: #c0c0c0; }
        
        /* Bright ANSI Colors (90-97) */
        .ansi-bright-black { color: #808080; }
        .ansi-bright-red { color: #ff0000; }
        .ansi-bright-green { color: #00ff00; }
        .ansi-bright-yellow { color: #ffff00; }
        .ansi-bright-blue { color: #0000ff; }
        .ansi-bright-magenta { color: #ff00ff; }
        .ansi-bright-cyan { color: #00ffff; }
        .ansi-bright-white { color: #ffffff; }
        
        /* Style Attributes */
        .ansi-bold { font-weight: bold; }
        .ansi-italic { font-style: italic; }
        .ansi-underline { text-decoration: underline; }
        
        /* MUD-specific combinations - bold versions have brighter colors */
        .ansi-bold.ansi-green { color: #00ff00; } /* Bright green for bold+green (like Redryx example) */
        .ansi-bold.ansi-red { color: #ff0000; }
        .ansi-bold.ansi-blue { color: #0000ff; }
        .ansi-bold.ansi-yellow { color: #ffff00; }
        .ansi-bold.ansi-cyan { color: #00ffff; }
        .ansi-bold.ansi-magenta { color: #ff00ff; }
        .ansi-bold.ansi-white { color: #ffffff; }
        
        body {
            background: #1a1a1a;
            color: #ffffff;
            font-family: 'Courier New', monospace;
            padding: 20px;
        }
        
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #444;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>ANSI Color Processing Test</h1>
    
    <div id="test-results"></div>
    
    <script>
        // Convert ANSI escape codes to HTML with CSS classes
        // Enhanced to properly handle MUD-specific patterns like [0;1;32m
        function ansiToHtml(text) {
            if (!text || typeof text !== 'string') return text;
            
            // ANSI color code mappings (30-37, 90-97)
            const colorMap = {
                '30': 'ansi-black', '31': 'ansi-red', '32': 'ansi-green', '33': 'ansi-yellow',
                '34': 'ansi-blue', '35': 'ansi-magenta', '36': 'ansi-cyan', '37': 'ansi-white',
                '90': 'ansi-bright-black', '91': 'ansi-bright-red', '92': 'ansi-bright-green',
                '93': 'ansi-bright-yellow', '94': 'ansi-bright-blue', '95': 'ansi-bright-magenta',
                '96': 'ansi-bright-cyan', '97': 'ansi-bright-white'
            };
            
            // Background color mappings (40-47, 100-107)
            const bgColorMap = {
                '40': 'ansi-bg-black', '41': 'ansi-bg-red', '42': 'ansi-bg-green', '43': 'ansi-bg-yellow',
                '44': 'ansi-bg-blue', '45': 'ansi-bg-magenta', '46': 'ansi-bg-cyan', '47': 'ansi-bg-white',
                '100': 'ansi-bg-bright-black', '101': 'ansi-bg-bright-red', '102': 'ansi-bg-bright-green',
                '103': 'ansi-bg-bright-yellow', '104': 'ansi-bg-bright-blue', '105': 'ansi-bg-bright-magenta',
                '106': 'ansi-bg-bright-cyan', '107': 'ansi-bg-bright-white'
            };
            
            // Style mappings
            const styleMap = {
                '1': 'ansi-bold',
                '2': 'ansi-dim',       
                '3': 'ansi-italic',
                '4': 'ansi-underline',
                '5': 'ansi-blink',     
                '7': 'ansi-reverse'    
            };
            
            let result = '';
            let currentClasses = new Set();
            let i = 0;
            
            while (i < text.length) {
                if (text[i] === '\x1b' && text[i + 1] === '[') {
                    // Found ANSI escape sequence \x1b[
                    let j = i + 2;
                    while (j < text.length && text[j] !== 'm') {
                        j++;
                    }
                    
                    if (j < text.length) {
                        // Parse the codes between [ and m
                        const codeString = text.substring(i + 2, j);
                        const codes = codeString.split(';');
                        
                        // Process each code in the sequence
                        for (const code of codes) {
                            const trimmedCode = code.trim();
                            
                            if (trimmedCode === '0' || trimmedCode === '') {
                                // Reset all formatting (code 0 or empty)
                                currentClasses.clear();
                            } else if (colorMap[trimmedCode]) {
                                // Foreground color - remove any existing foreground color first
                                const toRemove = [];
                                for (const cls of currentClasses) {
                                    if (cls.startsWith('ansi-') && 
                                        !cls.startsWith('ansi-bg-') && 
                                        !cls.startsWith('ansi-bold') && 
                                        !cls.startsWith('ansi-italic') && 
                                        !cls.startsWith('ansi-underline') &&
                                        !cls.startsWith('ansi-dim') &&
                                        !cls.startsWith('ansi-blink') &&
                                        !cls.startsWith('ansi-reverse')) {
                                        toRemove.push(cls);
                                    }
                                }
                                toRemove.forEach(cls => currentClasses.delete(cls));
                                currentClasses.add(colorMap[trimmedCode]);
                            } else if (bgColorMap[trimmedCode]) {
                                // Background color - remove any existing background color first
                                const toRemove = [];
                                for (const cls of currentClasses) {
                                    if (cls.startsWith('ansi-bg-')) {
                                        toRemove.push(cls);
                                    }
                                }
                                toRemove.forEach(cls => currentClasses.delete(cls));
                                currentClasses.add(bgColorMap[trimmedCode]);
                            } else if (styleMap[trimmedCode]) {
                                // Style attribute (bold, italic, etc.)
                                currentClasses.add(styleMap[trimmedCode]);
                            }
                            // Ignore unknown codes silently
                        }
                        
                        i = j + 1; // Move past the 'm'
                    } else {
                        // Malformed escape sequence, treat as regular character
                        result += escapeHtml(text[i]);
                        i++;
                    }
                } else {
                    // Regular character - collect consecutive chars with same formatting
                    let textRun = '';
                    const currentClassString = Array.from(currentClasses).join(' ');
                    
                    // Collect all consecutive characters that have the same formatting
                    while (i < text.length && 
                           !(text[i] === '\x1b' && text[i + 1] === '[')) {
                        textRun += text[i];
                        i++;
                    }
                    
                    // Apply formatting to the entire text run
                    if (currentClasses.size > 0) {
                        result += `<span class="${currentClassString}">${escapeHtml(textRun)}</span>`;
                    } else {
                        result += escapeHtml(textRun);
                    }
                }
            }
            
            return result;
        }

        // Escape HTML characters
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, (m) => map[m]);
        }

        // Test cases
        function runTests() {
            const tests = [
                {
                    name: 'Redryx Example (Bold Green)',
                    input: '\x1b[0;1;32mRedryx\x1b[0m',
                    expected: 'Bold green text'
                },
                {
                    name: 'Simple Red',
                    input: '\x1b[31mRed Text\x1b[0m',
                    expected: 'Red text'
                },
                {
                    name: 'Bold Yellow',
                    input: '\x1b[1;33mBold Yellow\x1b[0m',
                    expected: 'Bold yellow text'
                },
                {
                    name: 'Multiple Colors',
                    input: '\x1b[31mRed\x1b[0m \x1b[32mGreen\x1b[0m \x1b[34mBlue\x1b[0m',
                    expected: 'Red, green, blue text'
                },
                {
                    name: 'Complex MUD Output',
                    input: '\x1b[0;1;32mScore for \x1b[0;1;37mRedryx\x1b[0m\x1b[0;1;32m, Battle Tested.\x1b[0m',
                    expected: 'Complex colored score line'
                }
            ];

            const resultsContainer = document.getElementById('test-results');
            
            tests.forEach(test => {
                const result = ansiToHtml(test.input);
                
                const testDiv = document.createElement('div');
                testDiv.className = 'test-result';
                testDiv.innerHTML = `
                    <h3>${test.name}</h3>
                    <p><strong>Input:</strong> <code>${test.input.replace(/\x1b/g, '\\x1b')}</code></p>
                    <p><strong>Expected:</strong> ${test.expected}</p>
                    <p><strong>Result:</strong> ${result}</p>
                `;
                
                resultsContainer.appendChild(testDiv);
            });
        }

        // Run tests when page loads
        document.addEventListener('DOMContentLoaded', runTests);
    </script>
</body>
</html>